{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Carreras{% endblock %}

{% block extra_css %}
<style>
    .card-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .stats-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }

    .carrera-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .carrera-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }

    .badge-modalidad {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
        border-radius: 50px;
    }

    .progress-custom {
        height: 8px;
        border-radius: 10px;
    }

    .search-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .stats-icon {
            font-size: 1.5rem;
        }

        .card-stats h3 {
            font-size: 1.5rem;
        }

        .card-stats small {
            font-size: 0.7rem;
        }

        .search-container {
            padding: 1rem;
        }

        .carrera-card:hover {
            transform: none;
        }
    }

    @media (max-width: 768px) {
        .btn-group .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }

    @media (min-width: 768px) {
        .btn-nueva-carrera {
            padding: 0.5rem 1rem !important;
            font-size: 0.95rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold text-dark mb-1">
                <i class="fas fa-graduation-cap me-2 text-primary"></i>
                {% if es_alumno %}
                Oferta Académica
                {% elif user.rol == 'invitado' %}
                Ver Carreras
                {% else %}
                Gestión de Carreras
                {% endif %}
            </h2>
            <p class="text-muted mb-0">
                {% if es_alumno %}
                Explora la oferta académica disponible
                {% elif user.rol == 'invitado' %}
                Mira todas las carreras académicas de la institución
                {% else %}
                Administra las carreras académicas de la institución
                {% endif %}
            </p>
        </div>
        {% if user.rol == 'administrador' %}
        <div>
            <a href="{% url 'carreras:crear' %}" class="btn btn-primary btn-nueva-carrera"
                style="padding: 1rem 1.5rem;">
                <i class="fas fa-plus me-2"></i><span class="d-inline">Nueva Carrera</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Estadísticas -->
    {% if not es_alumno %}
    <div class="row mb-4">
        <div class="col-12 col-md-3 mb-3 mb-md-0">
            <div class="card card-stats h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-graduation-cap stats-icon"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ carreras_activas }}</h3>
                        <small class="opacity-75">Carreras Activas</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3 mb-3 mb-md-0">
            <div class="card card-stats h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-book stats-icon"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ total_materias }}</h3>
                        <small class="opacity-75">Total Materias</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3 mb-3 mb-md-0">
            <div class="card card-stats h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-users stats-icon"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ total_alumnos }}</h3>
                        <small class="opacity-75">Estudiantes Inscriptos</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3 mb-3 mb-md-0">
            <div class="card card-stats h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-chart-line stats-icon"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ page_obj.paginator.count }}</h3>
                        <small class="opacity-75">Total Registros</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filtros de Búsqueda -->
    {% if not es_alumno %}
    <div class="search-container">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                {{ filtro_form.buscar.label_tag }}
                {{ filtro_form.buscar }}
            </div>
            <div class="col-md-2">
                {{ filtro_form.modalidad.label_tag }}
                {{ filtro_form.modalidad }}
            </div>
            <div class="col-md-2">
                {{ filtro_form.duracion.label_tag }}
                {{ filtro_form.duracion }}
            </div>
            {% if user.rol == 'administrador' %}
            <div class="col-md-2">
                {{ filtro_form.activa.label_tag }}
                {{ filtro_form.activa }}
            </div>
            {% endif %}
            <div class="col-md-3 d-flex align-items-end gap-2 flex-wrap">
                <button type="submit" class="btn btn-outline-primary flex-grow-1">
                    <i class="fas fa-search me-1"></i>Buscar
                </button>
                <a href="{% url 'carreras:lista' %}" class="btn btn-outline-primary flex-grow-1">
                    <i class="fas fa-times me-1"></i>Limpiar
                </a>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Alerta para alumnos -->
    {% if es_alumno %}
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle fa-2x me-3"></i>
            <div>
                <h5 class="mb-1">Información para Alumnos</h5>
                <p class="mb-0">
                    {% if carreras_inscrito %}
                    Estás inscripto en:
                    {% for carrera in carreras_inscrito %}
                    <strong>{{ carrera.nombre }}</strong>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    . Puedes explorar otras carreras pero solo podrás inscribirte a materias de tu carrera.
                    {% else %}
                    No estás inscripto en ninguna carrera. Contacta a la administración para inscribirte.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista de Carreras -->
    <div class="row">
        {% for carrera in carreras %}
        <div class="col-12 col-sm-6 col-lg-4 mb-4">
            <div class="card carrera-card h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title fw-bold text-dark mb-1">{{ carrera.nombre }}</h5>
                            <p class="text-muted small mb-0">Código: {{ carrera.codigo }}</p>
                        </div>
                        <span class="badge badge-modalidad bg-primary">
                            {{ carrera.get_modalidad_display }}
                        </span>
                    </div>
                </div>

                <div class="card-body">
                    <p class="text-muted mb-3" style="font-size: 0.9rem; line-height: 1.4;">
                        {{ carrera.descripcion|truncatewords:20 }}
                    </p>

                    <!-- Información Principal -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="p-2">
                                <i class="fas fa-clock text-info mb-1"></i>
                                <div class="fw-bold">{{ carrera.duracion_anios }}</div>
                                <small class="text-muted">Años</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <i class="fas fa-book text-success mb-1"></i>
                                <div class="fw-bold">{{ carrera.total_materias|default:0 }}</div>
                                <small class="text-muted">Materias</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <i class="fas fa-users text-warning mb-1"></i>
                                <div class="fw-bold">{{ carrera.total_alumnos|default:0 }}</div>
                                <small class="text-muted">Alumnos</small>
                            </div>
                        </div>
                    </div>

                    <!-- Estado -->
                    <div class="mb-3">
                        {% if carrera.activa %}
                        <span class="badge bg-success">
                            <i class="fas fa-check me-1"></i>Activa
                        </span>
                        {% else %}
                        <span class="badge bg-danger">
                            <i class="fas fa-times me-1"></i>Inactiva
                        </span>
                        {% endif %}

                        {% if carrera.fecha_creacion %}
                        <small class="text-muted ms-2">
                            Creada: {{ carrera.fecha_creacion|date:"d/m/Y" }}
                        </small>
                        {% endif %}
                    </div>

                    <!-- Progress Bar para Materias -->
                    {% if carrera.total_materias > 0 %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Plan de Estudios</small>
                            <small class="text-muted">{{ carrera.total_materias }} materias</small>
                        </div>
                        <div class="progress progress-custom" style="height: 8px;">
                            <div class="progress-bar bg-success"
                                style="width: {% widthratio carrera.total_materias 40 100 %}%"
                                role="progressbar"
                                title="{{ carrera.total_materias }} materias">
                            </div>
                        </div>
                    </div>
                    {% endif %}
        </div>

        <div class="card-footer bg-transparent border-0 pt-0">
            <div class="d-grid gap-2">
                {% if es_alumno %}
                <!-- Vista para alumnos -->
                {% if carrera in carreras_inscrito %}
                <div class="alert alert-success alert-sm mb-2 py-2">
                    <small><i class="fas fa-check-circle"></i> Tu carrera</small>
                </div>
                {% endif %}
                <a href="{% url 'materias:por_carrera' carrera.pk %}"
                    class="btn btn-{% if carrera in carreras_inscrito %}primary{% else %}outline-info{% endif %} btn-sm">
                    <i class="fas fa-book me-1"></i>Ver Materias
                </a>
                {% else %}
                <!-- Vista para administradores y otros roles -->
                <div class="btn-group flex-wrap" role="group">
                    <a href="{% url 'carreras:detalle' carrera.pk %}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver
                    </a>
                    {% if user.rol == 'administrador' %}
                    <a href="{% url 'carreras:editar' carrera.pk %}" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-edit me-1"></i>Editar
                    </a>
                    <a href="{% url 'carreras:eliminar' carrera.pk %}" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-trash me-1"></i>Eliminar
                    </a>
                    {% endif %}
                </div>

                <!-- Botón de Materias visible para todos los roles -->
                <a href="{% url 'materias:por_carrera' carrera.pk %}" class="btn btn-success btn-sm">
                    <i class="fas fa-book me-1"></i>Materias ({{ carrera.total_materias|default:0 }})
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% empty %}
<div class="col-12">
    <div class="text-center py-5">
        <i class="fas fa-search text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
        <h3 class="text-muted mt-3">No se encontraron carreras</h3>
        <p class="text-muted">
            {% if request.GET %}
            Intenta ajustar los filtros de búsqueda.
            {% else %}
            No hay carreras registradas en el sistema.
            {% endif %}
        </p>
        {% if user.rol == 'administrador' and not request.GET %}
        <a href="{% url 'carreras:crear' %}" class="btn btn-primary btn-lg mt-3">
            <i class="fas fa-plus me-2"></i>Crear Primera Carrera
        </a>
        {% endif %}
    </div>
</div>
{% endfor %}
</div>

<!-- Paginación -->
{% if page_obj.has_other_pages %}
<div class="d-flex justify-content-center mt-4">
    <nav aria-label="Navegación de carreras">
        <ul class="pagination pagination-lg">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                    href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link"
                    href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link"
                        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
                {% endif %}
        </ul>
    </nav>
</div>
{% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Animación suave para las tarjetas
        const cards = document.querySelectorAll('.carrera-card');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('animate__animated', 'animate__fadeInUp');
        });

        // Efecto hover mejorado
        cards.forEach(card => {
            card.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-8px) scale(1.02)';
            });

            card.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });
    });
</script>
{% endblock %}